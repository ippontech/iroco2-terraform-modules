schemaVersion: "0.3"
parameters:
  tagname:
    type: String
assumeRole: "${aws_iam_role_arn}"
mainSteps:
  - name: "DescribeVpcEndpoints"
    action: "aws:executeScript"
    nextStep: "DeleteVpcEndpoints"
    isEnd: false
    inputs:
      Runtime: "python3.8"
      Handler: "describe_vpc_endpoints"
      Script: |
        import boto3

        def describe_vpc_endpoints(events, context):
            client = boto3.client('ec2')
        
            tag_name = events['tagname']
            
            response = client.describe_vpc_endpoints(Filters=[
                {
                    'Name': 'tag:auto-shutdown',
                    'Values': [
                        tag_name
                    ]
                },
            ])
            endpoint_ids = []
            for endpoint in response['VpcEndpoints']:
                endpoint_ids.append(endpoint['VpcEndpointId'])
                    
            return {"value" : endpoint_ids}
      InputPayload:
        tagname: "{{tagname}}"
    outputs:
      - Type: "StringList"
        Name: "Output"
        Selector: "$.Payload.value"

  - name: "DeleteVpcEndpoints"
    action: "aws:executeAwsApi"
    isEnd: true
    inputs:
      Service: "ec2"
      Api: "DeleteVpcEndpoints"
      VpcEndpointIds: "{{ DescribeVpcEndpoints.Output }}"
    outputs:
      - Type: "String"
        Name: "output"
        Selector: "$.Payload.message"
